{"componentChunkName":"component---src-templates-blog-post-js","path":"/2018/12/17/writing-a-vscode-extension-with-fable-2-1/","result":{"data":{"site":{"siteMetadata":{"title":"blog.nojaf.com","author":"Florian Verdonck"}},"markdownRemark":{"id":"a5b91ef4-03ab-56cc-8e53-3ac291ea3308","excerpt":"Introduction This post is part of the F# Advent Calendar in English 2018. I’m very grateful to be a part of this and I hope you will enjoy this one as much as I…","html":"<h2>Introduction</h2>\n<p>This post is part of the <strong><a href=\"https://sergeytihon.com/2018/10/22/f-advent-calendar-in-english-2018/\">F# Advent Calendar in English 2018</a></strong>. I’m very grateful to be a part of this and I hope you will enjoy this one as much as I have enjoyed the others.</p>\n<p>Today I would like to show you how you can create <a href=\"https://code.visualstudio.com/docs/extensions/overview\">VS Code extension</a> from scratch using <strong>Fable</strong>. Along the way we write some code that will extend the <a href=\"https://www.markdownguide.org/getting-started\">Markdown</a> syntax.</p>\n<h2>Project setup</h2>\n<h3>Code extension</h3>\n<p>To get started we will follow the general approach of scaffolding a new extension. Using the <a href=\"https://code.visualstudio.com/docs/extensions/yocode\">yeoman</a> generator we will scaffold a new <em>JavaScript</em> extension.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/473f82c71001c8c1871c1da20220b763/683fc/yo-code.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.30316248636859%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB7UlEQVQ4y41T7W7aQBD0w7TF8flsg+svjFUMTlCR+LKxCYGmRALe/w0muyucIEqk/hjd+c43N7OzZ/R6PpJ+gjgOEAQBPM8TdLtd2LYt0Fp/zK/B67cwTNNEVyn4vo9hnmM6nWIymSCnueu6ULT3FZnjOPLPNQzXdZAmIaIoENIsy0hxH6zcJaWaDjlf4JZMCBXd5jkK2lYwLQsdUtzpmFCWgqttghYIwR1CmfP+Bcbj5BFlWWG1KlGt1zIulkv8Itua1H5LEvyIIpik3qLDii61qAzqAou+bYLmMthEWNYlTsczzuczjqcTDocDjscjmt0OaVEgHI0QD4eI0hQpIaELGH0qS0rg8SeFqVgpE46fRti9vmC//4PD2xv2r3/x9HuK+WyG5XyOgkhTJoljOdwSMviCAcEnQpvts2XL/Y4497CuajSbDZarFeZEVFWVgBO3b9tGfc7ZNltt62vo3gMGRYB63QjhqiyxpBo2dY2crLp30pWW0c7doD4J6wab52dRWBPZhsizwUBseG2a/wFD+w/IJiERbLF92YpNJmQU47GQRpQyt4h3p+/+6UObFCYjn2yWKIlsNl9QDRdim5uc2+L6aX1Yvoy3ewZHHnGC3BJ9ejGhK6+GVbWpSpqklMd2PQxD+Zb2uezz2ju8o63FtXqlxQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"vs code\"\n        title=\"vs code\"\n        src=\"/static/473f82c71001c8c1871c1da20220b763/799d3/yo-code.png\"\n        srcset=\"/static/473f82c71001c8c1871c1da20220b763/00d96/yo-code.png 148w,\n/static/473f82c71001c8c1871c1da20220b763/0b23c/yo-code.png 295w,\n/static/473f82c71001c8c1871c1da20220b763/799d3/yo-code.png 590w,\n/static/473f82c71001c8c1871c1da20220b763/2a3d6/yo-code.png 885w,\n/static/473f82c71001c8c1871c1da20220b763/683fc/yo-code.png 917w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>Adding Fable</h3>\n<p>In order to add Fable we need two main pieces: a couple of npm modules and some NuGet packages.<br>\nFirst, we will add them with yarn.</p>\n<blockquote>\n<p>PS> cd fable-markdown-extension</p>\n<p>PS> yarn add -D “fable-compiler” “fable-splitter”</p>\n</blockquote>\n<p>We won’t be using webpack as we don’t really need a bundle in this scenario. When a plugin is installed all JavaScript is executed in a node environment. All files are on disk so there is no need to bundle in order to spare some network requests.</p>\n<ul>\n<li>fable-compiler? The piece of Fable that compiles your F# source code. Don’t be confused by the fact that this is a npm package. It contains a <code class=\"language-text\">.NET</code> executable and a compiled version of <code class=\"language-text\">Fable.Core</code>. Although it is not really that important to know all this.</li>\n<li>fable-splitter? This npm package can compile multiple F# files linked by a <code class=\"language-text\">.fsproj</code> when configured correctly. We will use the splitter to compile F# files to JavaScript and nothing more. Under the hood <code class=\"language-text\">fable-splitter</code> uses <code class=\"language-text\">fable-compiler</code>.</li>\n</ul>\n<p>Next we need a F# project. This can be a simple <code class=\"language-text\">netstandard classlib</code>.</p>\n<blockquote>\n<p>PS> dotnet new classlib -lang F# -o src -n AdventExtension</p>\n</blockquote>\n<p>This created a <code class=\"language-text\">src</code> folder with a <code class=\"language-text\">Library.fs</code> file in it. Let us try and compile this to JavaScript using <code class=\"language-text\">fable-splitter</code>.<br>\nIn our <code class=\"language-text\">package.json</code> we can add a new script called <code class=\"language-text\">build</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  \"scripts\": {\n    \"postinstall\": \"node ./node_modules/vscode/bin/install\",\n    \"build\": \"fable-splitter --config splitter.config.js\"\n}</code></pre></div>\n<p>And as you would expect we will also need a <code class=\"language-text\">splitter.config.js</code> file.<br>\nThe configuration looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">const path = require(\"path\");\n\nfunction resolve(relativePath) {  \n  return path.join(__dirname, relativePath);\n}\n\nmodule.exports = {  \n  entry: resolve(\"src/AdventExtension.fsproj\"),\n  outDir: resolve(\"out\"),\n  allFiles: true\n};</code></pre></div>\n<p>Execute by running <code class=\"language-text\">yarn build</code>. This is the equivalent of running <code class=\"language-text\">npm run build</code>. Yarn just doesn’t need the <code class=\"language-text\">run</code> word.<br>\nWe see that all the files in the project are compiled to the <code class=\"language-text\">out</code> folder as specified in <code class=\"language-text\">splitter.config.js</code>.</p>\n<p>Now let us rename <code class=\"language-text\">Library.fs</code> and change it to <code class=\"language-text\">Extension.fs</code>, compile again and try to run our extension.</p>\n<p>The <code class=\"language-text\">main</code> property of our <code class=\"language-text\">package.json</code> is pointing to <code class=\"language-text\">./extension</code>, so we will need to change that into <code class=\"language-text\">out/Extension.js</code>.<br>\nHowever if we look at the existing <code class=\"language-text\">extension.js</code> file it seems to expose an <code class=\"language-text\">activate</code> function.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// The module 'vscode' contains the VS Code extensibility API\n// Import the module and reference it with the alias vscode in your code below\nconst vscode = require('vscode');\n\n// this method is called when your extension is activated\n// your extension is activated the very first time the command is executed\nfunction activate(context) {\n\n    // Use the console to output diagnostic information (console.log) and errors (console.error)\n    // This line of code will only be executed once when your extension is activated\n    console.log('Congratulations, your extension \"fable-markdown-extension\" is now active!');\n\n    // The command has been defined in the package.json file\n    // Now provide the implementation of the command with  registerCommand\n    // The commandId parameter must match the command field in package.json\n    let disposable = vscode.commands.registerCommand('extension.sayHello', function () {\n        // The code you place here will be executed every time your command is executed\n\n        // Display a message box to the user\n        vscode.window.showInformationMessage('Hello World!');\n    });\n\n    context.subscriptions.push(disposable);\n}\nexports.activate = activate;\n\n// this method is called when your extension is deactivated\nfunction deactivate() {  \n}\nexports.deactivate = deactivate;  </code></pre></div>\n<p>So we will need this in our Fable code as well.<br>\nChanging <code class=\"language-text\">Extension.fs</code> to</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">module AdventExtension.Extension\n\nlet activate _ =  \n    printfn \"Fable extension is activated!\"</code></pre></div>\n<p>should do the trick.</p>\n<p>At this point we have had to compile for a couple times already. It would be easier if we could compile continuously.<br>\nThis can be achieved by means of another <code class=\"language-text\">fable-splitter</code>, so let’s add a new build script <code class=\"language-text\">watch</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    \"scripts\": {\n        \"postinstall\": \"node ./node_modules/vscode/bin/install\",\n        \"build\": \"fable-splitter --config splitter.config.js\",\n        \"watch\": \"yarn run build --watch\"\n    },</code></pre></div>\n<blockquote>\n<p>yarn watch</p>\n</blockquote>\n<p>Our compiled code looks like</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import { toConsole, printf } from \"./fable-library.2.1.8/String\";  \nexport function activate(_arg1) {  \n  toConsole(printf(\"Fable extension is activated!\"));\n}</code></pre></div>\n<p>and we can launch the extension in code by hitting the play button in the Debug panel.<br>\nHowever in our current setup we want our extension to run when VS Code starts.</p>\n<p>Change the <code class=\"language-text\">activationEvents</code> to <code class=\"language-text\">*</code> in the <code class=\"language-text\">package.json</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  \"activationEvents\": [\n    \"*\"\n  ]</code></pre></div>\n<p>and start debugging.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 460px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a96927a8495bf0fe0fe99a17d9e683a6/d5727/debug.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 102.17391304347827%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABuElEQVQ4y62U3Y7BUBDH+xrYi0W11Q+tVbbFUiHxFRKWFUQiceOplgdwaZ/vv2fGyvoIydpe/DPp6cxv5pwzZyT3tQivWIZpmnCcLCwrA103xLclrA7DMGFYJmzHRqlUYtm2I/wslm3b8P0iMhlb+BqQGvU6up0O0iK4UqnA83wGqaoGTUsjmZBRrJQxGL8jm31BPl/A83McyaTMyRzHQbn8xsWk0zok13XZyfd9tFot9Pt91Go15HI5sZ4XkCyCoIb9/gvb7Rabzw12ux1msxnvynXzDCV/slK1WkWz2YSiqJz1KFlOnWk4HGKxWGDyMRGwORcRjyeQSiks8qE4yfM8UJWapvHi0eFUsqwgFntCJBJFNBpje4SdxsiyANbFGbbbbbGQ4sBr2CGAdqCqKlvS6b9fK4C090KhwM63KjwGXeoyKQOn0ynW6/XPuSk3gfd0Buz1epjP51dZHwYGQYBGo8HnEgqw2+1iNBpd3djDQGpoek70MkIB0hmOx+OHYVdAampqm3uN/Scgvd/BYBDepdAAODR2SBUul0usVquzh/4vIE0bUmhbphlGomEaCpCGAymsW/4GEphanOxa5RsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"debug\"\n        title=\"debug\"\n        src=\"/static/a96927a8495bf0fe0fe99a17d9e683a6/d5727/debug.png\"\n        srcset=\"/static/a96927a8495bf0fe0fe99a17d9e683a6/00d96/debug.png 148w,\n/static/a96927a8495bf0fe0fe99a17d9e683a6/0b23c/debug.png 295w,\n/static/a96927a8495bf0fe0fe99a17d9e683a6/d5727/debug.png 460w\"\n        sizes=\"(max-width: 460px) 100vw, 460px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>This opens a new instance of <code class=\"language-text\">vscode</code> and should contain our extension.</p>\n<p>Yikes, this isn’t really doing anything at all!<br>\nWe even see a crash when we toggle the developer tools.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f8c37c50c7bdca4652a227666fe38dec/bd44f/debug-failure-line-one-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.20560747663551%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACnUlEQVQozz2S204TURSG5wUsFbjQHubQaWfaKaVAO22lhBATX0kTSaAC1RsTr3wCX0CvTDTGEKMXakQTAbHSAj0OPTGddhhoye+aqTLJyr/2JPvb/7/2ZtLZZWTuLCKTTiOZVJFIJEmTSKVSUFXV0UQiAUVRkM8/xreDJl5/KuH912Ontncq+LjbwofvDWz/qINJJBYQCErw+1l4vR74fD5SLwIBkSrg9Czrh9vtxvp6DgPrCvWmDq1toNHSUTvVUS3uo1PaQbNSBJNKqRDkWfDyHFhOoM0swf0IBoOQZRlelqBcEDfck3iUy8H+rkbDazX7ffz+8gJv3j1Bbf8lmGw2C57nCMTBz3LXQNtdOBxGSJIgCAG4b46Bl4MBtIaGbvcM3bMuKTn8+Qr7n5+jVXgLJpNOIajMQ4qpTnRB4J3YNlAURae3D3G5XMhvbeHSsqBpGnRdh2EYpD2YZx3A6sMgZZbIISfNQYyqEOUouIBEoDGM53kHZveT09PYWFuD1enAtM4xGo1gEbxPkXvlCs4HJrTTJph4PO5s9Pu8TlT2X+xQKOTM0YbZ6wn3BHIEvLKGMCimYTvs9dButdClQzrttqNMLDbjOOOlGDhRpoux4ePINlQQhLHDqSlsPFzFRb2FZqGEzskJtFIJ1UIBerUKo17HgEbBxGYIFklCiK+AFULOzDwej+PaBv6/JBc9m837D4BKDb29XzAPDnCxtwerWIRB8N7REQa1mh2ZnkxIpqejkDsWclBENKpglv7PLcwjQn1EieCW9zY2V1cxLGlo7/6BfngIk2AWuRxWaIYEtGyHd9V7UKU00uEMkiFSKYOl2AoWZ5ahyotOZSJLiPrjeJp/hlZbx/FxGSflMioUtUGQeqOB02YTpmniL0AvEAfAcxzDAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"crash in logs\"\n        title=\"crash in logs\"\n        src=\"/static/f8c37c50c7bdca4652a227666fe38dec/799d3/debug-failure-line-one-1.png\"\n        srcset=\"/static/f8c37c50c7bdca4652a227666fe38dec/00d96/debug-failure-line-one-1.png 148w,\n/static/f8c37c50c7bdca4652a227666fe38dec/0b23c/debug-failure-line-one-1.png 295w,\n/static/f8c37c50c7bdca4652a227666fe38dec/799d3/debug-failure-line-one-1.png 590w,\n/static/f8c37c50c7bdca4652a227666fe38dec/2a3d6/debug-failure-line-one-1.png 885w,\n/static/f8c37c50c7bdca4652a227666fe38dec/ae92f/debug-failure-line-one-1.png 1180w,\n/static/f8c37c50c7bdca4652a227666fe38dec/bd44f/debug-failure-line-one-1.png 1284w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>What code is telling us here is that it doesn’t know how to deal with the <code class=\"language-text\">import</code> and <code class=\"language-text\">export</code> keywords.<br>\nI believe this whole thing is running in a node context, so we should be using <code class=\"language-text\">module.exports</code> instead.</p>\n<p>One small Babel plugin can do this for us. We need to download it with <code class=\"language-text\">yarn</code> and tell <code class=\"language-text\">fable-splitter</code> to use it as well.</p>\n<blockquote>\n<p>PS> yarn add -D “@babel/plugin-transform-modules-commonjs” “@babel/core”</p>\n</blockquote>\n<p><code class=\"language-text\">splitter.config.js</code> becomes</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">const path = require(\"path\");\n\nfunction resolve(relativePath) {  \n  return path.join(__dirname, relativePath);\n}\n\nmodule.exports = {  \n  entry: resolve(\"src/AdventExtension.fsproj\"),\n  outDir: resolve(\"out\"),\n  babel: {\n    plugins: [\"@babel/plugin-transform-modules-commonjs\"]\n  },\n  allFiles: true\n};</code></pre></div>\n<p>The JavaScript output now looks like</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {  \n  value: true\n});\nexports.activate = activate;\n\nvar _String = require(\"./fable-library.2.1.8/String\");\n\nfunction activate(_arg1) {  \n  (0, _String.toConsole)((0, _String.printf)(\"Fable extension is activated!\"));\n}</code></pre></div>\n<p>and our extension now runs!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3d556a0ded333155570b83687dc1ffff/3eaa1/extension-loaded.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.16060961313013%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAC7UlEQVQ4y2WTW07bQBSGvYEGEl7aJL7FdhJTQrm0PFZq2r60UrfQhxYIsIaqu2ABSBW0L1RiGUAlhEgJF5MbsWM7iRMCIUHJ3zOGQCUsfTozHvufc878w0mSBIYoij6KoiAUCmEpk0HfrqJkGLjudjEYDHB1deXTue6gUauhRWtdz0Oz1US73cbm5ia4SCSCIdFoFKIg+IILC4vo1D04VZsEuuh0rv3Y7fZogx48r4mGaeGi3oDXbOHmpo+NjQ1wmqYhmUxCVVVfVCDBkZFREvyKy7YDr17C5YWNeq0C8/wMrl1Gq2mjUTdh09hrWD5AD79+roOLx+NgosOyY7KM0dEgVpbn0WrUYBznUMznYFUM2NYZ6m4ZdadIsXSPXc2T4CW2tn6D03Xdz04mISaqxGIIBkPILH5Gy6ugVC6iSpmY1gn1isTqBTiugUajiJpjkLhBbTkGBh5l+AMcK5FlxsoNh8N+HwOBADLLK+hTsy/+HqBnnGJQLhFU7ukpnNwh3GwWzvk5XNdFtcpKBtbW1sBNpiaRSqUow5gvzLIdC40hk1lCz6Ue7u/j+uQE/UoFfdNEu1SCQ3P36Ag2zR0maFUfBJ9Fn4IREcI+gszjSTCAxfkvuCzYqBxSn85MeBZBP7vFIkzbhuk41AYLFlGhzdizvk6HkpY+gPFGvCUtfcT75Cd8W/yO3M4uDnb/IEsc7Gwju72N4709FPL5WwoF5Cka5Mca+XJ1dRXcuJrCkOcsKhOIiwkokuafeIwOShYlinfjmIIYIdPh/Q97J9E3nKKpGKISskKLaoy8qVA/Zeh6HFNTKZrHoROaQvYSolBkgTbkaZNbJJH333GaSh8N0eJkGxUvEyrezep4O6Pj9YsE0jPjSE/rmJuQMT0hYSIhYpbizB1T4xImdQnjcZHdlFshTdX8qNJdniajv0rqPjNk/NlEEnN0mxSB7MXz4HmB4B8RJe4F1aEgRbbAkx+ZJ3k++jAWeP9qCvfxMf8ALTyayZHgR88AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"extension runs\"\n        title=\"extension runs\"\n        src=\"/static/3d556a0ded333155570b83687dc1ffff/799d3/extension-loaded.png\"\n        srcset=\"/static/3d556a0ded333155570b83687dc1ffff/00d96/extension-loaded.png 148w,\n/static/3d556a0ded333155570b83687dc1ffff/0b23c/extension-loaded.png 295w,\n/static/3d556a0ded333155570b83687dc1ffff/799d3/extension-loaded.png 590w,\n/static/3d556a0ded333155570b83687dc1ffff/3eaa1/extension-loaded.png 853w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>F# dependencies</h3>\n<p>Ok, after some trial and error we have the basics in place. However, a little intelliSense would not hurt.<br>\nThere is a NuGet package for that: <a href=\"https://www.nuget.org/packages/Fable.Import.VSCode/\">Fable.Import.VSCode</a>.</p>\n<p>We could install it into our <code class=\"language-text\">fsproj</code> with <code class=\"language-text\">dotnet add</code>, but I would prefer to download it with <code class=\"language-text\">paket</code> instead.<br>\nPaket can easily be added to a project using:</p>\n<blockquote>\n<p>PS> dotnet tool install —tool-path “.paket” Paket —add-source <a href=\"https://api.nuget.org/v3/index.json\">https://api.nuget.org/v3/index.json</a></p>\n</blockquote>\n<p>This downloads the <code class=\"language-text\">.NETCore</code> version of Paket into a <code class=\"language-text\">.paket</code> folder. This should be familiar to most of us.<br>\nNext we enter <code class=\"language-text\">.paket\\paket.exe init</code>.</p>\n<p>Open the <code class=\"language-text\">paket.dependencies</code> file and add</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">source https://www.nuget.org/api/v2  \nstorage:none  \nframework: netstandard2.0\n\n# nuget Fable.Import.Jest // Use when ready for Fable2\ngithub nojaf/fable-jest:fable2 fable/Bindings.fs  \ngithub nojaf/fable-jest:fable2 fable/Exports.fs  \ngithub nojaf/fable-jest:fable2 fable/Matchers.fs  \nnuget FSharp.Core redirects:force  \nnuget Fable.Import.VSCode  \nnuget Fable.Parsimmon  </code></pre></div>\n<p>It will download <code class=\"language-text\">VS Code</code> bindings, <code class=\"language-text\">Jest</code> bindings and <code class=\"language-text\">Fable.Parsimmon</code>. I’ll explain later why we need those.<br>\nThen, create a <code class=\"language-text\">paket.references</code> file next to the fsproj.</p>\n<p>Add</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Fable.Import.VSCode  \nFable.Parsimmon  \nFile:Bindings.fs Jest  \nFile:Exports.fs Jest  \nFile:Matchers.fs Jest  </code></pre></div>\n<p>Run <code class=\"language-text\">.paket\\paket.exe install</code>, which should add everything on <strong>.NET</strong> side.</p>\n<h3>Those last npm packages</h3>\n<p>To wrap up the setup of the project, we still need a few npm packages.</p>\n<blockquote>\n<p>yarn add -D “jest” “markdown-it”</p>\n</blockquote>\n<p>That should be it. Thanks for sticking around if you are still here 😊.<br>\nNow we can finally start coding.</p>\n<h2>Revelations</h2>\n<p>I feel like we have been through a lot already, and I haven’t really revealed the master plan of all this.<br>\nI mentioned that we would extend Markdown. In this blogpost we will add two new features:</p>\n<ul>\n<li>Fable logo</li>\n<li>Fable font</li>\n</ul>\n<h3>Fable logo</h3>\n<p>Whenever we type <code class=\"language-text\">:fable:</code> in our Markdown file, we would like to <a href=\"https://fable.io/img/fable_logo.png\">the Fable logo</a> to show in our preview.</p>\n<h3>Fable text</h3>\n<p>If we add text between two <code class=\"language-text\">🐉</code> emoji, it should rendered in a different font.</p>\n<p>Both features should also be <strong>highlighted</strong> in the editor itself.</p>\n<h2>Test-driven development</h2>\n<p>Now that we know what we want, we can start thinking about solving the problem.<br>\nWithout considering VS Code we know that we will need a way to detect<code class=\"language-text\">:fable:</code> and text between <code class=\"language-text\">🐉</code>.</p>\n<p>What better way of parsing text than using <a href=\"https://github.com/Zaid-Ajaj/Fable.Parsimmon\">Fable.Parsimmon</a>?<br>\nIf you have any experience with <a href=\"http://www.quanttec.com/fparsec/\">FParsec</a>, the API is very similar.</p>\n<p>In order to have a <strong>short feedback loop</strong>, we can easily do some <strong>TDD</strong> instead of trying things out in the extension itself.</p>\n<p>We already installed <a href=\"https://jestjs.io/\">Jest</a> and the accompanying F# bindings. Note that these bindings were installed with paket through <code class=\"language-text\">github</code> instead of <code class=\"language-text\">nuget</code>. This has to do with the fact that <a href=\"https://github.com/jgrund/fable-jest/issues/13\">Fable.Jest doesn’t work 100% with Fable 2.X</a>.</p>\n<p>My fork of <a href=\"https://github.com/jgrund/fable-jest/pull/14\">Fable.Jest</a> contains a workaround for this.<br>\nHere you can already see that using <code class=\"language-text\">paket</code> instead of <code class=\"language-text\">NuGet</code> was a smart move.</p>\n<p><strong>Unit testing in Fable</strong> is described to some extent in the <a href=\"https://fable.io/faq/#unit-tests\">FAQ</a>. In our case everything is almost fully set up. We need to change the <code class=\"language-text\">test</code> script in our package.json.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\"scripts\": {\n    \"postinstall\": \"node ./node_modules/vscode/bin/install\",\n    \"build\": \"fable-splitter --config splitter.config.js\",\n    \"watch\": \"yarn run build --watch\",\n    \"test\": \"jest\"\n},</code></pre></div>\n<p>Add a file that matches the following convention <code class=\"language-text\">*.test.fs</code> to our project, and the <code class=\"language-text\">*.test.js</code> should be picked up by <strong>Jest</strong>.<br>\n<code class=\"language-text\">Parser.test.fs</code> with a <em>simple unit test</em> should be enough for now.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">module AdventExtension.Tests.Parser\n\nopen Fable.Import.Jest  \nopen Fable.Import.Jest.Matchers\n\ntest \"simple Jest test should be picked up\" &lt;| fun () ->  \n    \"42\" == \"the answer of the Universe\"</code></pre></div>\n<p>Execute with</p>\n<blockquote>\n<p>PS> yarn build</p>\n<p>PS> yarn test</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2c528b939633877846a9884dc9ea30c3/41c64/failing-test.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 93.2367149758454%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB40lEQVQ4y41TSZKcMBDs/3/EFx/nIZ6rY3phQKxCe2mXmKI99g3aGRAhFKQqlZV1sR6GlYxT3zwazpj3wQCAMUop5/22bbXW7QAX1ba/f/6Qcy+lUnKHBUgpxRBzztspLn6amrc38rhPdJ3maRiHha7WOSElShCcO+cOyaiq5hwZywDR6KRU5CwpHZY1SJFTKqUckvFOwYJcWcRfOQMpBV2ZWWfoXYAXsvGNMXDJ7dMnAxoFx5ziFkstr8khhM+l+eTdqGcKyyB7GlZf/PYKOxm9lfPsnP23W/EyW31N/tNGFBxTTnXLpWCbUkandqtwr5R6Ri45SyEk2Pswt6S/Xa9d196uH4SQx6PB7p9WrtV7j7FIwccQYtzjgUZ4XIdYzysjMAyAB9QNdQbv8AjvLCrHkzAk5SBq32TsE9eGGrdqGFe2cIGBk0ZTShnjRzl53rkUSpemuS/L0jD9saoHN5/aE2H6cQILR6PxXVlrzTnHSWJCKPzwgYLnNnAXtPNH8b5YawfST9hnA5lSjxqeUrf/wAWz/P7rnXPhrCW3GwpAi/3fST4Z5p0MWs19zxjDkm3XgbXlCQz8OXMnBxcE5UNPSEeGfiBd1xEyTWPXtrsLUmL4rAWMitYKcG60xmk3WuPzBfRqULSVphPzAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"failing test\"\n        title=\"failing test\"\n        src=\"/static/2c528b939633877846a9884dc9ea30c3/799d3/failing-test.png\"\n        srcset=\"/static/2c528b939633877846a9884dc9ea30c3/00d96/failing-test.png 148w,\n/static/2c528b939633877846a9884dc9ea30c3/0b23c/failing-test.png 295w,\n/static/2c528b939633877846a9884dc9ea30c3/799d3/failing-test.png 590w,\n/static/2c528b939633877846a9884dc9ea30c3/41c64/failing-test.png 621w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a href=\"https://www.youtube.com/watch?v=VzDN7mCDoC0\">Coolio</a>, we can unit test now! The way I like to proceed now is having two console windows. One to run <code class=\"language-text\">fable-splitter</code> with <code class=\"language-text\">yarn watch</code>, and other to run tests with <code class=\"language-text\">yarn test --watchAll</code>.</p>\n<h2>Fable.Parsimmon</h2>\n<p>Since we are going to parse text, we need a type to capture the result of our parsing.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">type ParserResult =  \n    | Text of string\n    | FableFontText of NodeResult&lt;string>\n    | FableLogo of NodeResult&lt;string></code></pre></div>\n<p>We may now have found some text, text between dragons (🐉) or <code class=\"language-text\">:fable:</code>.<br>\nWhen we have found one or both of the latter two, we would need to know where in our text we have found them.<br>\nThis is where <code class=\"language-text\">Parsimmon.node</code> comes in handy, as it returns a <code class=\"language-text\">NodeResult&lt;'t></code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">type TokenPosition =  \n    { offset: int\n      line: int\n      column: int }\n\ntype NodeResult&lt;'t> =  \n    { name: string\n      value: 't\n      start: TokenPosition\n      ``end``: TokenPosition }</code></pre></div>\n<p>Next we need a function that takes a string and returns <code class=\"language-text\">Fable.Parsimmon.ParseResult&lt;ParserResult array></code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">let parseText input : ParseResult&lt;ParserResult array> = failwith \"Nothing here yet.\"  </code></pre></div>\n<p>And we can quickly write some tests.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">test \"basic fable font\" &lt;| fun () ->  \n    let input = \"🐉vibes🐉\"\n    let parsed = Parser.parseText input\n    parsed.status == true\n\ntest \"no fable font\" &lt;| fun () ->  \n    let input = \"fableless vibes\"\n    let parsed = Parser.parseText input\n    parsed.status == true\n\ntest \"fable logo is found\" &lt;| fun () ->  \n    let input = \"Once upon a :fable:...\"\n    let parsed = Parser.parseText input\n\n    parsed.status == true\n\n    match parsed.value with\n    | [| Text _; FableLogo logo; Text _|] ->\n        logo.start.offset == 12\n        logo.value.Length == 7\n    | _ -> failwith \"Expected logo in center\"</code></pre></div>\n<p>Notice that <code class=\"language-text\">==</code> is a shorthand for <code class=\"language-text\">Fable.Import.Jest.Exports.expect.Invoke(\"foo\").toBe(\"bar\")</code>.</p>\n<p>To make these tests pass we’ll write some custom parsers, mostly based on regular expressions.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">module AdventExtension.Parser\n\nopen Fable.Parsimmon  \nopen Fable.Core  \nopen System.Text.RegularExpressions\n\ntype ParserResult =  \n    | Text of string\n    | FableFontText of NodeResult&lt;string>\n    | FableLogo of NodeResult&lt;string>\n\n// no /g flag\n[&lt;Emit(\"new RegExp($0)\")>]\nlet createRegex pattern : Regex = jsNative\n\nlet dragonParser = Parsimmon.str \"🐉\"\n\nlet noDragonParser =  \n    Parsimmon.regex (createRegex @\"[^🐉]+\")\n\nlet fableFontParser =  \n    Parsimmon.between dragonParser dragonParser noDragonParser\n    |> Parsimmon.node \"FableFont\"\n    |> Parsimmon.map (ParserResult.FableFontText)\n\nlet halfDragon =  \n    \"🐉\".ToCharArray()\n    |> Array.head\n    |> (string)\n\nlet noDragonsParser =  \n    Parsimmon.satisfy (fun token -> token &lt;> halfDragon &amp;&amp; token &lt;> \":\")\n        |> Parsimmon.atLeastOneOrMany\n        |> Parsimmon.concat\n        |> Parsimmon.map (ParserResult.Text)\n\nlet fableLogoParser =  \n    Parsimmon.str \":fable:\"\n    |> Parsimmon.node \"FableLogo\"\n    |> Parsimmon.map (FableLogo)\n\nlet parseText input : ParseResult&lt;ParserResult array> =  \n    Parsimmon.choose [ \n        fableLogoParser\n        noDragonsParser\n        fableFontParser\n    ] \n    |> fun parser -> parser.many().parse(input)</code></pre></div>\n<p>I won’t go into detail about exactly how this works but I do want to highlight two things:</p>\n<ul>\n<li><code class=\"language-text\">\"🐉\".Length</code> returns <code class=\"language-text\">2</code>. And <code class=\"language-text\">Parsimmon.satisfy</code> only compares a single token at a time.</li>\n<li>Creating a <code class=\"language-text\">Regex</code> via the .NET API compiles to a JavaScript Regex that uses the <code class=\"language-text\">/g</code> flag. This is something we don’t want in this case, so I’ve added a little helper that emits a <code class=\"language-text\">Regex</code>.</li>\n</ul>\n<p>Presumably this code is more or less readable, and we can continue 😅.</p>\n<h2>Highlighting code</h2>\n<p>Highlighting in VS Code is surprisingly easily. All we need to do is tell code which <code class=\"language-text\">range</code> should be decorated with which <code class=\"language-text\">style</code>.</p>\n<p>Let’s first create some <code class=\"language-text\">TextDecorationEditorStyle</code> objects.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">module AdventExtension.Extension\n\nopen Fable.Core.JsInterop  \nopen Fable.Import.vscode\n\nlet createFontOptions color backgroundColor fontWeight : DecorationRenderOptions =  \n    jsOptions (fun options ->\n        options.color &lt;- Some color\n        options?fontWeight &lt;- fontWeight\n        options.backgroundColor &lt;- backgroundColor\n    )\n\nlet activate _ =  \n    let fableFontStyle = window.createTextEditorDecorationType(createFontOptions \"#87c5fd\" (Some \"white\") None)\n    let fableLogoStyle = window.createTextEditorDecorationType(createFontOptions \"#87c5fd\" None (Some \"bold\"))\n\n    printfn \"Fable extension activated!\"</code></pre></div>\n<p>Now we need to subscribe to certain events.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">let activate (context: ExtensionContext) =  \n    let fableFontStyle = window.createTextEditorDecorationType(createFontOptions \"#87c5fd\" (Some \"white\") None)\n    let fableLogoStyle = window.createTextEditorDecorationType(createFontOptions \"#87c5fd\" None (Some \"bold\"))\n\n    // Capture the active editor.\n    let mutable activeEditor = window.activeTextEditor\n\n    let updateDecorations() = failwithf \"Nothing here yet.\"\n\n    let mutable timeoutKey = None;\n    let triggerUpdateDecorations _ =\n        timeoutKey\n        |> Option.iter (JS.clearTimeout)\n\n        timeoutKey &lt;- Some (JS.setTimeout updateDecorations 500)\n\n    // User is typing\n    window.onDidChangeActiveTextEditor.Invoke((fun editor ->\n        activeEditor &lt;- Some editor\n        triggerUpdateDecorations()\n        null\n    ))\n    |> context.subscriptions.Add\n\n    // Change of document\n    workspace.onDidChangeTextDocument.Invoke((fun event ->\n        match activeEditor with\n        | Some aEditor when (event.document = aEditor.document) ->\n            triggerUpdateDecorations()\n        | _ -> ()\n        null\n    ))\n    |> context.subscriptions.Add\n\n    activeEditor\n    |> Option.iter (triggerUpdateDecorations)\n\n    printfn \"Fable extension activated!\"</code></pre></div>\n<p>Notice that the event handlers call <code class=\"language-text\">triggerUpdateDecorations</code>, which prevents us from re-rendering too much.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// Parsimmon ranges are 1-based, VS Code works with 0-based indexing.\nlet nodeResultToRange&lt;'t> (nr: NodeResult&lt;'t>) =  \n    let zeroBasedFloat r = r - 1 |> (float)\n    vscode.Range(zeroBasedFloat nr.start.line,\n                 zeroBasedFloat nr.start.column,\n                 zeroBasedFloat nr.``end``.line,\n                 zeroBasedFloat nr.``end``.column)\n\nlet updateDecorations() =  \n    activeEditor\n    |> Option.iter (fun aEditor ->\n        if aEditor.document.languageId = \"markdown\" then\n            let text = aEditor.document.getText()\n            let parsed = Parser.parseText text\n\n            if parsed.status then\n                parsed.value\n                |> Array.map (fun node ->\n                    match node with\n                    | ParserResult.FableLogo logo ->\n                        Some (fableLogoStyle, nodeResultToRange logo)\n\n                    | ParserResult.FableFontText fableText ->\n                        Some (fableFontStyle, nodeResultToRange fableText)\n\n                    | _ ->\n                        None\n\n                )\n                |> Array.choose id\n                |> Array.groupBy (fun (style,_) -> style.key)\n                |> Array.iter (fun (styleKey, ranges) ->\n                    let r =\n                        Array.map snd ranges\n                        |> ResizeArray\n\n                    let style = if fableFontStyle.key = styleKey then fableFontStyle else fableLogoStyle\n\n                    aEditor.setDecorations(style, !^ r)\n                )\n    )</code></pre></div>\n<p><code class=\"language-text\">updateDecorations</code> is rather straightforward as well. We map the result of <code class=\"language-text\">parseText</code> and make ranges out of it. The result looks as follows:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 440px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9241f006892f0dab63b9108ff3f3dd96/bafff/markdown-highlighting-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.31818181818181%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAA7DAAAOwwHHb6hkAAACSUlEQVQoz31S2XLaQBDU/39AXvIFSbmSOFCJQyDEQbINMrdAAoTQARb3Ja0Ors6wIna5KslD185qe3tnuiU09BbqPQXjgYyJVYHdl+FaVXQVEUOjjNHgEVavhCezwtFri7D1EiZOHX3tjnPGdg1mt4j1VIXQVe/RIZLWvMWDnIdS+Y5WNQulnMFALWA57WDutrCatOEturSq0NsS6o8ZNAhKJUv8HJrE11u3EJqlFMqFd6hV8rj+kYEsfUZRTKH68AV9IqxXJmauiqXbRuyZiLcmDFWCmP8A+S5N/DRKUorXSvkbhJ6Sh9bIwZu2sdsOEKwNeCTijg2OxcKBOz3Dxo45QDTCgdkEK4H/gj1B0OpZFH+9hzfvYOc7CKmD2LOwWZpgGwvbWQeLscofCjfG8xpuBgnWfb6PLhA6jSzUaoYENRK0+WHsj+BOTMynOoVVgqFJ8Ocq/MUF8xfEJOoveryhMwS1lkH1/poONerOorFGcAwJY1dHFIdgoY94FyCOfARUs8BDeP5GexYx9DoiddbnVhwDJxEsSx/BKMGIRo39IUZOEU9jjYtt/SUYWyGKViR4QUD7YEnrGroukg06TuGQe0sj5yidr88jB+Qhtg72I/KURHfDNvY0Ukx1THVktxBT6kdm4kQgEk5BIsY7lAtXuPn0BmyZdOivB0SmRDcm9mTBnoLhq3euTY4DPXygywdKfc/TTsR4h3rrJ85JezMymIiMTD7R4fEfONBofy7/7VyQxStk028pqW5iLP/H/gfnVUdH9lrwNw5wcG3UcUJ0AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Markdown highlighting in VS Code\"\n        title=\"Markdown highlighting in VS Code\"\n        src=\"/static/9241f006892f0dab63b9108ff3f3dd96/bafff/markdown-highlighting-1.png\"\n        srcset=\"/static/9241f006892f0dab63b9108ff3f3dd96/00d96/markdown-highlighting-1.png 148w,\n/static/9241f006892f0dab63b9108ff3f3dd96/0b23c/markdown-highlighting-1.png 295w,\n/static/9241f006892f0dab63b9108ff3f3dd96/bafff/markdown-highlighting-1.png 440w\"\n        sizes=\"(max-width: 440px) 100vw, 440px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Preview mode</h2>\n<p>When we switch to preview mode of the Markdown file, we don’t really see any changes.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 440px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6723609f69c56431830f4b400567a18d/bafff/preview-before-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACJUlEQVQ4y31T2XLaQBDU/z/nOY8pVyWVcio2dioYHMyNEYhDJwgJBFgCxI257M7smPKRGD907exot6enZyWVzRr6dh5+uwTHyuGuXYZRu4HbyCPwFLiU8zsK+vS907yFWU/SmRJsIwNLTfH5hpZCz5Ex9lVIhpaGVU+gULxGvRSFWo6hLkdhVuPQq9eoylfQlRj0SpzXpppE6BsYdqsY9mqYBBqvY1/DbGhAKiROoNClb79/IfPnFCmCnD2HWrxEIRNB8uYnsolTFNNnUHLncI0UxoMGk4R3KsaEsK9iGhhYhhYkXYlSogosXTys2ozdwsF27nD8KHLLJ+zpzGbWolwHj/ceocPxA++fVimf+Ir5UCfpBmpyHFolgW5LhmfLaGoZmLUUeZpEy8gx7ic2k+1FkQPZa0jV2wjJVbGetth0zy5icPBHxD2nxBBFeoT11Gay3cJ9F8+EoqpIiCrigthj0wXWb3GM6JkwEz/hljczF31XYXWDbu3FI149LoR1D9j6R9vllo3KFREa5GGFWstiNbZpb2I2MLAYWTy9+chk7wJPtJ5mpXse0v+QIt8/YRU24XfzMNULzAKL39ioX8dy3OD3JVTPBiacRhL1yg9WenQoSv6MPVyGNg1FhmOKP4TUtkpoqGkehlDEnm77wC74uOVU7AtV13nKIakSiqaBjim1LB7shOKXltw3g3uXMHbxmQg0migZvvYO0/Rexd0PCf7FX6p0utsLBokXAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Preview mode before\"\n        title=\"Preview mode before\"\n        src=\"/static/6723609f69c56431830f4b400567a18d/bafff/preview-before-1.png\"\n        srcset=\"/static/6723609f69c56431830f4b400567a18d/00d96/preview-before-1.png 148w,\n/static/6723609f69c56431830f4b400567a18d/0b23c/preview-before-1.png 295w,\n/static/6723609f69c56431830f4b400567a18d/bafff/preview-before-1.png 440w\"\n        sizes=\"(max-width: 440px) 100vw, 440px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>This can be changed by writing our own <a href=\"https://markdown-it.github.io/\">markdown-it</a> extension.<br>\nTo be fair, it took me a while to figure out how this works. Even after reading the <a href=\"https://github.com/markdown-it/markdown-it/blob/master/docs/architecture.md\">documentation</a>, I was still somewhat puzzled.</p>\n<p>What <code class=\"language-text\">markdown-it</code> does is it parses the Markdown content to a token stream.</p>\n<p>Ex.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">This is some **markdown text**  </code></pre></div>\n<p>Will be parsed to</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[\n  {\n    \"type\": \"paragraph_open\",\n    \"tag\": \"p\",\n  },\n  {\n    \"type\": \"inline\",\n    \"tag\": \"\",\n    \"map\": [\n      0,\n      1\n    ],\n    \"nesting\": 0,\n    \"level\": 1,\n    \"children\": [\n      {\n        \"type\": \"text\",\n        \"tag\": \"\",\n        \"content\": \"This is some \",\n      },\n      {\n        \"type\": \"strong_open\",\n        \"tag\": \"strong\",\n      },\n      {\n        \"type\": \"text\",\n        \"tag\": \"\",\n        \"content\": \"markdown text\",\n      },\n      {\n        \"type\": \"strong_close\",\n        \"tag\": \"strong\",\n      },\n      {\n        \"type\": \"text\",\n        \"tag\": \"\",\n      }\n    ],\n    \"content\": \"This is some **markdown text**\",\n  },\n  {\n    \"type\": \"paragraph_close\",\n    \"tag\": \"p\",\n  }\n]</code></pre></div>\n<p>Note that this is a simplified version. We need to break down any tokens of <code class=\"language-text\">type:\"text\"</code> and replace them with our own token type (<code class=\"language-text\">fable-logo</code> and <code class=\"language-text\">fable-text</code>).</p>\n<p>Once we’ve updated the tree, we can hook into the render engine by adding custom rules.</p>\n<h3>F# bindings</h3>\n<p>I found that there are TypeScript bindings on <a href=\"https://www.npmjs.com/package/@types/markdown-it\">npm</a>. With <a href=\"https://github.com/fable-compiler/ts2fable\">ts2fable</a> I cooked up some <a href=\"https://github.com/nojaf/fable-markdown-extension/blob/master/src/MarkdownIt.fs\">minimal F# bindings</a> which we can use.</p>\n<h3>Unit tests</h3>\n<p>Since this is a rather tricky situation, we should add some tests first.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">module AdventExtension.Tests.MarkdownPlugin\n\nopen Fable.Import.Jest  \nopen AdventExtension.MarkdownPlugin\n\njest.unmock(\"markdown-it\")\n\nlet md = MarkdownItModule.Exports.Invoke().``use``(fableMarkdownPlugin)\n\ntest \"fable img is rendered\" &lt;| fun () ->  \n    let input = \":fable:\"\n    let parsed = md.render input\n    expect.Invoke(parsed.StartsWith(\"&lt;p>&lt;img class='fable-logo' src\")).toBeTruthy()\n\ntest \"fable font is rendered\" &lt;| fun () ->  \n    let input = \"Over the seas 🐉we shall rise🐉!\"\n    let parsed = md.render input\n    expect.Invoke(parsed.Contains(\"&lt;span class='fable'>we shall rise&lt;/span>\")).toBeTruthy()</code></pre></div>\n<p>The plugin function <code class=\"language-text\">fableMarkdownPlugin</code> looks like</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">module AdventExtension.MarkdownPlugin\n\nopen MarkdownItModule  \nlet fableMarkdownPlugin (md: MarkdownIt) (options: Options) = failwith \"Nothing yet\"  </code></pre></div>\n<p>Inside this function, we need to replace the tokens and add custom render rules.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">module AdventExtension.MarkdownPlugin\n\nopen MarkdownItModule  \nopen Fable.Core  \nopen AdventExtension.Parser\n\n[&lt;Emit(\"new $0.Token($1,$2,$3)\")>]\nlet createToken state name tag nesting: Token = jsNative\n\n[&lt;Emit(\"$0[$1] = $2\")>]\nlet addRenderRule rules name fn: unit = jsNative\n\nlet fableMarkdownPlugin (md: MarkdownIt) (options: Options) =  \n    // Phase one: replace text tokens to custom tokens\n    let replaceTokens (state: State) =\n        let parseTextToken (parentToken: Token) (textToken: Token) = \n            let textContent = textToken.content\n            let parsedContent = parseText textContent\n            let updatedChildren =\n                if not parsedContent.status then\n                    Array.empty\n                else\n                    parsedContent.value\n                    |> Array.map (fun node ->\n                        match node with\n                        | ParserResult.Text text ->\n                            let t = createToken state \"text\" \"\" 0\n                            t.content &lt;- text\n                            t\n\n                        | ParserResult.FableLogo _ ->\n                            createToken state \"fable-logo\" \"img\" 0\n\n                        | ParserResult.FableFontText fontText ->\n                            let t = createToken state \"fable-font\" \"span\" 0\n                            t.content &lt;- fontText.value.Replace(\"🐉\", \"\")\n                            t\n                    )\n\n            parentToken.children &lt;- new ResizeArray&lt;Token>(updatedChildren)\n\n        let rec parseToken (parentToken: Token) (token: Token) =\n            if token.children &lt;> null &amp;&amp; not(Seq.isEmpty token.children) then\n                token.children\n                |> Seq.iter (fun childToken ->\n                    if childToken.``type`` = \"inline\" then\n                        parseToken token childToken\n                    else\n                        parseTextToken token childToken \n                )\n\n            if token.``type`` = \"text\" then\n                parseTextToken parentToken token\n\n        state.tokens\n        |> Seq.filter (fun t -> t.``type`` = \"inline\" &amp;&amp; t.children &lt;> null &amp;&amp; not (Seq.isEmpty t.children))\n        |> Seq.iter (fun token ->\n            token.children\n            |> Seq.iter (parseToken token)\n        )\n\n    md.core.ruler.push(\"fable\", replaceTokens)</code></pre></div>\n<p>This code might not look like much, but we are traversing the tree, replacing the <code class=\"language-text\">children</code> of a parent node that contains <code class=\"language-text\">text</code>.</p>\n<p>Our unit tests remain unaffected, as the render part will just ignore the <code class=\"language-text\">fable-logo</code> and <code class=\"language-text\">fable-text</code> tokens and render them as regular <code class=\"language-text\">text</code>.</p>\n<p>Part two determines how our own nodes should render:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[&lt;Emit(\"$0[$1] = $2\")>]\nlet addRenderRule rules name fn: unit = jsNative\n\nlet fableMarkdownPlugin (md: MarkdownIt) (options: Options) = ...  \n    // Phase one ...\n\n    // Phase two\n    let renderFableLogo tokens idx = \"&lt;img class='fable-logo' src='data:image/png;base64,iVBORw0KGgoAAAANSUhEU...' />\"\n\n    let renderFableText (tokens: Token array) (idx: int) =\n        let token = tokens.[idx]\n        sprintf \"&lt;span class='fable'>%s&lt;/span>\" (token.content.Replace(\"🐉\", \"\"))\n\n    addRenderRule md.renderer.rules \"fable-logo\" (new System.Func&lt;Token array,int,string>(fun tokens idx -> renderFableLogo tokens idx))\n    addRenderRule md.renderer.rules \"fable-font\" (new System.Func&lt;Token array,int,string>(fun tokens idx -> renderFableText tokens idx))</code></pre></div>\n<p>We need to wrap our render functions inside a <code class=\"language-text\">System.Func&lt;_,_,_></code> in order to preserve compatibility with JavaScript.<br>\nThe reason for this is that Fable compiles these into functions that can be curried, and markdown-it doesn’t like this.</p>\n<p>Once more our tests show green, and the times has come to shove this into our VS Code extension.</p>\n<h3>Tag on code</h3>\n<p>To see all this in code we need to extend the <code class=\"language-text\">contributes</code> section in our <code class=\"language-text\">package.json</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  \"contributes\": {\n    \"markdown.markdownItPlugins\": true,\n    \"markdown.previewStyles\": [\n      \"./fable.css\"\n    ]\n  }</code></pre></div>\n<p>Create a <code class=\"language-text\">fable.css</code> file</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// this works in code, I was somewhat surprised by this. Should be a local url in real world scenario.\n@import url('https://fonts.googleapis.com/css?family=Josefin+Slab:400,600i'); \n\n.fable {\n    font-family: 'Josefin Slab', serif;\n    font-weight: 600;\n    font-style: italic;\n    color: #87c5fd;\n    font-size: 18px;\n}\n\n.fable-logo {\n    display: inline-block;\n    width: 24px;\n}</code></pre></div>\n<p>And make the final change to <code class=\"language-text\">Extension.fs</code> by adding</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    // Add render plugin\n    createObj [\n        \"extendMarkdownIt\" ==> (fun md -> md?``use``(MarkdownPlugin.fableMarkdownPlugin))\n    ]</code></pre></div>\n<p>at the end.</p>\n<p>Final outcome:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 459px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/975c1e5833c830738e040a5169778c37/1f645/preview-after.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.605664488017425%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB10lEQVQoz4WSW3eaQBSF+f+v/Qd97FptH7qSNiHNxRpjKyCUi4DRKDcvUUHkYhKTncNAE2td6cO3zpxhZs/ew3CKrWF808JoIMC/EeH1BdhaHWNHpl5AMJAwGrYZXeOS1WH3F647DTbuW1eYuDLCiYHFRAfXNerQlAtc/jyFIfFQRR4aYatnUKQTqDSnt09gyt9h/T7DNNAxY2hMpKjxrYX5SEefDuGk+geI4jmOajzExhe0GgfQpWOYbR7N5je0rg4gEppwhJ5+gXBabDYQjgs6iCadUpCEbfUHOEs9RTo3gdzBU+4Ca49qSTku57D28Zi5Ve9Xc9U6ovi2SR1wQv0jsrALfyBDah5Da5/DuW6hbzbZuKCj1Ni93noqEyg27lIIFnA2OVzNLGySAZZ0J9HEpN5mMYo4S6phFSsLe3hIhrgnHna4r+DExmfkCwuzaITpIqAYdFL+GnubP7HegtPEr8hIME0CjMY9zDwZjyzCvzxVdVPF2wdzmMwtcuXjLnGQxQ7WKw/rxEO+euUucV8qE033u+Vq/Huk5DAjh/PQxyIKGPHSRxJ7CCOfKPslkcbei+Beh6bC008w2RPYjbfNX5FTt1q3R/Dw0ztyaG89B/e/vOXwGab8dsZZOYzaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"preview after\"\n        title=\"preview after\"\n        src=\"/static/975c1e5833c830738e040a5169778c37/1f645/preview-after.png\"\n        srcset=\"/static/975c1e5833c830738e040a5169778c37/00d96/preview-after.png 148w,\n/static/975c1e5833c830738e040a5169778c37/0b23c/preview-after.png 295w,\n/static/975c1e5833c830738e040a5169778c37/1f645/preview-after.png 459w\"\n        sizes=\"(max-width: 459px) 100vw, 459px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>The Source</h2>\n<p>You can find all code on my <a href=\"https://github.com/nojaf/fable-markdown-extension\">github</a>.</p>\n<h2>Remarks</h2>\n<ul>\n<li>The extension has not been published in the store, nor do I have the intention to so.</li>\n<li>This was my first <strong>VS Code</strong> and <strong>markdown-it</strong> plugin, so there is some room for improvement.</li>\n<li><code class=\"language-text\">fable-splitter</code> is very fast. I didn’t miss <code class=\"language-text\">fable-loader</code> and <code class=\"language-text\">webpack</code> for a single moment.</li>\n<li>Many thanks to <a href=\"https://github.com/Zaid-Ajaj\">Zaid Ajaj</a> for the help with Fable.Parsimmon.</li>\n</ul>\n<h2>Final words</h2>\n<p>I hope you enjoyed this blogpost and it all makes sense to you. If you have any suggestions or questions, please leave a comment.</p>\n<p>Yours truly,<br>\nnojaf</p>\n<p>Photo by <a style=\"background-color:black;color:white;text-decoration:none;padding:4px 6px;font-family:-apple-system, BlinkMacSystemFont, &quot;San Francisco&quot;, &quot;Helvetica Neue&quot;, Helvetica, Ubuntu, Roboto, Noto, &quot;Segoe UI&quot;, Arial, sans-serif;font-size:12px;font-weight:bold;line-height:1.2;display:inline-block;border-radius:3px\" href=\"https://unsplash.com/@playjack01?utm_medium=referral&amp;utm_campaign=photographer-credit&amp;utm_content=creditBadge\" target=\"_blank\" rel=\"noopener noreferrer\" title=\"Download free do whatever you want high-resolution photos from Massimo Rinaldi\"><span style=\"display:inline-block;padding:2px 3px\"><svg xmlns=\"http://www.w3.org/2000/svg\" style=\"height:12px;width:auto;position:relative;vertical-align:middle;top:-2px;fill:white\" viewBox=\"0 0 32 32\"><title>unsplash-logo</title><path d=\"M10 9V0h12v9H10zm12 5h10v18H0V14h10v9h12v-9z\"></path></svg></span><span style=\"display:inline-block;padding:2px 3px\">Massimo Rinaldi</span></a></p>","frontmatter":{"title":"Writing a VSCode extension with Fable 2.1","date":"2018-12-17","path":"2018/12/17/writing-a-vscode-extension-with-fable-2-1/","tags":["javascript","fable","fp","fsharp"],"cover":{"publicURL":"/static/nojaf-fable-vscode-extension-065efacf066eeae01996303d4c129d90.jpg"}}}},"pageContext":{"slug":"/vscode-extension-with-fable/","previous":{"fields":{"slug":"/react-hooks-fable/"},"frontmatter":{"title":"React hooks preview with Fable","path":"2018/11/10/react-hooks-in-fable/","tags":["javascript","fable","fp","fsharp","react"]}},"next":{"fields":{"slug":"/building-fable-on-travis-ci/"},"frontmatter":{"title":"Building Fable on Travis CI","path":"2019/09/01/building-fable-on-travis/","tags":["javascript","fable","fsharp"]}}}}}